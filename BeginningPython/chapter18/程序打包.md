#第18章 程序打包
Setuptools和较旧的Distutils都是用于发布Python包的工具包，让你能够使用Python轻松地编写安装脚本。
这些脚本可用于生成可发布的归档文档，供用户用来编译和安装你编写的库。  
下面主要介绍Setuptools。实际上，Setuptools不光用于创建基于脚本的Python安装程序，还可以用于编译扩展。
另外，通过将其与扩展py2exe和py2app结合起来使用，还能创建独立的Windows和macOS可执行程序。  
## 18.1 Setuptools基础  
通过编写简单的脚本，即可食用Setuptools完成多种任务。
```python
from setuptools import setup

setup(name='Hello',
      version='1.0',
      description='A simple example',
      author='zjx',
      py_modules=['hello'])
```
上面的参数不是固定的，可以什么都不传，参数的含义也很明显。创建脚本后，存储为setup.py，并确保同级目录中包括模块hello.py。  
如果直接运行`python setup.py`将输出如下内容：  
```shell
usage: setup.py [global_opts] cmd1 [cmd1_opts] [cmd2 [cmd2_opts] ...]
   or: setup.py --help [cmd1 cmd2 ...]
   or: setup.py --help-commands
   or: setup.py cmd --help

error: no commands supplied
```
从上述输出可知，要获得更多的信息，可使用开关--help或--help-commands。尝试执行命令build，让Setuptools行动起来。  
`python setup.py build`  
输出如下：
```shell
running build
running build_py
creating build
creating build\lib
copying hello.py -> build\lib
```
Setuptools创建了一个名为build的目录，其中包含子目录lib。同时将hello.py复制到了lib中。
目录build相当于工作区，Setuptools在其中组装包（以及编译扩展库等）。安装时不需要执行命令build，
因为当执行install时，如果需要，命令build会自动执行。
> 注意 如果运行install，那么将会把hello.py复制到PYTHONPATH指定的特定目录中。但这只是咱们测试一下，所以应该找到它并删掉。
> 为此，要将安装位置记录下来；可以在setup.py的输出中找到。  
> 也可以使用开关-n，这样就只进行演示。

尝试安装一下：  
`$ python setup.py install`  
输出：
```text
running install
running bdist_egg
running egg_info
creating Hello.egg-info
writing Hello.egg-info\PKG-INFO
writing dependency_links to Hello.egg-info\dependency_links.txt
writing top-level names to Hello.egg-info\top_level.txt
writing manifest file 'Hello.egg-info\SOURCES.txt'
reading manifest file 'Hello.egg-info\SOURCES.txt'
writing manifest file 'Hello.egg-info\SOURCES.txt'
installing library code to build\bdist.win-amd64\egg
running install_lib
running build_py
creating build\bdist.win-amd64
creating build\bdist.win-amd64\egg
copying build\lib\hello.py -> build\bdist.win-amd64\egg
byte-compiling build\bdist.win-amd64\egg\hello.py to hello.cpython-38.pyc
creating build\bdist.win-amd64\egg\EGG-INFO
copying Hello.egg-info\PKG-INFO -> build\bdist.win-amd64\egg\EGG-INFO
copying Hello.egg-info\SOURCES.txt -> build\bdist.win-amd64\egg\EGG-INFO
copying Hello.egg-info\dependency_links.txt -> build\bdist.win-amd64\egg\EGG-INFO
copying Hello.egg-info\top_level.txt -> build\bdist.win-amd64\egg\EGG-INFO
zip_safe flag not set; analyzing archive contents...
creating dist
creating 'dist\Hello-1.0-py3.8.egg' and adding 'build\bdist.win-amd64\egg' to it
removing 'build\bdist.win-amd64\egg' (and everything under it)
Processing Hello-1.0-py3.8.egg
Copying Hello-1.0-py3.8.egg to c:\users\administrator\appdata\local\programs\python\python38\lib\site-packages
Adding Hello 1.0 to easy-install.pth file

Installed c:\users\administrator\appdata\local\programs\python\python38\lib\site-packages\hello-1.0-py3.8.egg
Processing dependencies for Hello==1.0
Finished processing dependencies for Hello==1.0
```
之后便可以使用模块hello了
```shell
>>> import hello
>>> hello.say_hello()
我是hello模块输出的内容
>>>
```
> 注意 如果运行的Python版本不是你安装的，并且你没有合适的权限，可能被禁止安装模块，因为你没有写入相应目录的权限。

这就是用于安装Python模块、包和扩展的标准机制。你只需提供一个小小的安装脚本即可。
如你所见，在安装过程中， Setuptools创建了一个.egg文件，这是一个独立的Python包。  
这里的例子只使用了py_modules。如果要安装整个包，可以用类似的方式（列出包名）使用指令packages。
你还可设置很多其他的选项。这些选项让你能够指定要安装什么以及安装到什么地方，等等。另外，编写好的脚本还可以和其他参数搭配，比如创建可发布的归档文件。 

## 18.2 打包
编写让用户能够安装模块的脚本setup.py之后，可以用它来创建归档文件。比如来创建Windows安装程序、RPM包、egg文件、wheel文件等。下面只介绍一下如何创建tar.gz文件。  
要创建源代码归档文件，可以使用命令sdist（表示source distribution）。
```shell
python setup.py sdist
```
执行上面的命令之后，可能会得到大量输出，有些输出是警告，比如说：`warning: check: missing meta-data: if 'author' supplied, 'author_email' should be supplied too`
意味着如果你提供了author参数，还应该提供author_email。  
真实的输出如下：
```shell
running sdist
running egg_info
creating Hello.egg-info
writing Hello.egg-info/PKG-INFO
writing dependency_links to Hello.egg-info/dependency_links.txt
writing top-level names to Hello.egg-info/top_level.txt
writing manifest file 'Hello.egg-info/SOURCES.txt'
reading manifest file 'Hello.egg-info/SOURCES.txt'
writing manifest file 'Hello.egg-info/SOURCES.txt'
warning: sdist: standard file not found: should have one of README, README.rst, README.txt, README.md

running check
warning: check: missing required meta-data: url

warning: check: missing meta-data: if 'author' supplied, 'author_email' should be supplied too

creating Hello-1.0
creating Hello-1.0/Hello.egg-info
copying files to Hello-1.0...
copying hello.py -> Hello-1.0
copying setup.py -> Hello-1.0
copying Hello.egg-info/PKG-INFO -> Hello-1.0/Hello.egg-info
copying Hello.egg-info/SOURCES.txt -> Hello-1.0/Hello.egg-info
copying Hello.egg-info/dependency_links.txt -> Hello-1.0/Hello.egg-info
copying Hello.egg-info/top_level.txt -> Hello-1.0/Hello.egg-info
Writing Hello-1.0/setup.cfg
creating dist
Creating tar archive
removing 'Hello-1.0' (and everything under it)
```
你会发现，除了目录build外，还有一个名为dist的目录，其中有一个Hello-1.0.tar.gz文件。可以将它分发给其他人，对方可以解压缩并执行setup.py来安装。  
还有很多其他的格式，可使用命令行开关 --formats(这个开关为复数形式，表明你可指定多种用逗号分隔的格式，这样将一次性创建多个归档文件)。
要获悉可使用的格式列表，可给命令sdist指定开关--help-formats。

# 18.3 编译扩展
上一章讲了如何编写Python扩展。之前的编译有点儿麻烦，所幸Setuptools也可以用来完成这种任务。假设源代码文件（palindrome2.c）在当前目录中，
则可以使用下面的setup.py来编译（并安装）它。
```python
from setuptools import setup, Extension

setup(name='palindrome',
      version='1.0',
      ext_modules=[
          Extension('palindrome', ['palindrome2.c'])
      ])
```
如果使用上面的脚本进行install操作，将自动编译扩展模块palindrome再安装它。
这里没有指定一个模块名列表，而是将参数ext_modules设置为一个Extension实例列表。
构造函数Extension将一个名称和一个相关文件列表作为参数;例如，可在这个文件列表中指定头文件(.h)。  
如果只想就地编译扩展(在大多数UNIX系统中，这都将在当前目录中生成一个名为 palindrome.so的文件)，可使用如下命令:
```shell
python setup.py build_ext --inplace
```
如果安装了SWIG，可以让Setuptools直接使用它。使用SWIG的话就不用自己编写复杂的包装代码了。
为此，需要做的非常简单，只需将接口文件(.i文件)的名称加入到Extension实例的文件列表中即可。
```python
from setuptools import setup, Extension

setup(name='palindrome',
      version='1.0',
      ext_modules=[
          Extension('palindrome', ['palindrome2.c',
                                   'palindrome2.i'])
      ])
```
如果用刚才的命令(build_ext，可能还要加上开关--inplace)运行这个脚本，也将生成一个.so文件(或与之等价的文件)，但这次无需自己编写包装代码。
注意，我给这个扩展指定了名称_palindrome，因为SWIG将创建一个名为palindrom.py的包装器，而这个包装器将通过名称_palindrome导入一个C语言库。

## 18.4 使用py2exe创建可执行程序
py2exe是Setuptools的一个扩展（可以使用pip来安装），它让你可以创建可执行的Windows程序（.exe文件）。
这样用户就可以不用单独安装Python解释器了。py2exe包可用来创建带GUI的可执行文件。下面举个例子：
```python
print('Hello, world!')
input('Press <enter>')
```
把上面的文件命名为hello.py并放在一个目录中，再在同一目录创建setup.py
```python
from distutils.core import setup
import py2exe

setup(console=['hello.py'])
```
可以像下面这样执行脚本：
```shell
python setup.py py2exe
```
这将创建一个控制台应用程序(hello.exe)，还将在子目录dist中创建其他几个文件。你可从命令行运行这个应用程序，也可通过双击来运行它。  
有关py2exe的工作原理和高级用法的详细信息，请参阅py2exe官网(http://www.py2exe.org)。 
如果你使用的是macOS，可以了解一下py2app。
