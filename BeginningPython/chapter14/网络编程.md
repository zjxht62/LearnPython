# 网络编程
## 14.1 几个网络模块
### 14.1.1 模块socket
套接字是网络编程中的一个基本组件。套接字基本上是一个信息通道，两端各有一个程序，这些程序可能位于网络上不同的计算机上，通过套接字来发送信息。
Python中，大多数网络编程都隐藏了模块socket的基本工作原理，不与套接字直接交互。  

套接字分为两类：服务器套接字和客户端套接字。  
服务端套接字：等待连接请求，在某个地址+端口处监听，直到客户套接字建立连接。  
客户端套接字：连接服务端套接字，完成后断开连接。  

套接字是`模块socket`中`socket类`的实例。实例化套接字时最多可指定三个参数:  
一个地址族 (默认为socket.AF_INET);  
是流套接字(socket.SOCK_STREAM，默认设置)还是数据报套接字 (socket.SOCK_DGRAM);  
协议(使用默认值0就好)。  
创建普通套接字时，不用提供任何参数。  

服务器套接字先调用方法bind，再调用方法listen来监听特定的地址。然后客户端套接字就可以连接到服务器了，方法是使用connet并提供调用bind时的地址。
(在服务器端， 可使用函数socket.gethostname获取当前机器的主机名)。这里的地址是一个格式为(host, port)的元组。
方法listen接 受一个参数——待办任务清单的长度(即最多可有多少个连接在队列中等待接纳，到达这个数量后将开始拒绝连接)。  
服务器套接字开始监听之后，就可以接受客户端的连接了，这是使用方法accept来完成的。这个方法将阻断（等待）到客户端连接到来为止，
然后返回一个格式为(client, address)的元组，其中client是一个客户端套接字，而address是地址。
> 这里讨论的服务器编程形式称为阻断(同步)网络编程。

为传输数据，套接字提供了两个方法:send和recv(表示receive)。要发送数据，可调用方法send并提供一个字符串;要接收数据，可调用recv并指定最多接收多少个字节的数据。
如果不 确定该指定什么数字，1024是个不错的选择。

举例：最见到的客户端和服务器程序。
```python
# 最简单的服务器
import socket
# 创建socket实例
s = socket.socket()
host = socket.gethostname()
port = 8765
# 先调用bind方法
s.bind((host, port))
# 在调用listen方法开始监听 5表示最多可有5个连接在队列中等待接纳
s.listen(5)
while True:
    c, addr = s.accept()
    print('Got connection from', addr) 
    c.send(b'Thank you for connecting')
    c.close()
```
```python
# 最简单的客户端
import socket
s = socket.socket()

host = socket.gethostname()
port = 8765

# 连接到服务器
s.connect((host, port))
print(s.recv(1024))
```

### 14.1.2 模块urllib和urllib2
urllib和urllib2可以通过网络访问文件。通过简单的函数调用，就几乎可以将统一资源定位符（URL)可指向的任何动作作为程序的输入。
通过和正则表达式模块re进行结合，可以下载网页并提取信息
urllib2比urllib更好，urllib2相比于urllib来说，可以实现HTTP身份验证或Cookie，或编写扩展来处理自己的协议。

1. 打开远程文件

使用模块urllib.request中的函数urlopen，就可以像打开本地文件那样打开远程文件，但是只能使用读取模式
```python
from urllib.request import urlopen
# webpage是一个类似于文件的对象
webpage = urlopen('http://www.python.org')
```
urlopen返回的类似于文件的对象支持方法close、read、readline和readlines，还支持迭代等。   
比如要找出网页链接中About的相对URL，可使用正则表达式
```python
from urllib.request import urlopen
import re
# 注意要在编译正则表达式的时候指定是否忽略大小写属性
pat = re.compile(b'<a href="([^"]+)" .*?>about</a>', re.IGNORECASE)
webpage = urlopen('http://www.python.org')
text = webpage.read()
m = pat.search(text)
print(m.group(1))
```

2. 获取远程文件

函数urlopen返回一个类似于文件的对象，可从中读取数据。如果要让urllib替你下载文件， 并将其副本存储在一个本地文件中，可使用urlretrieve。
这个函数不返回一个类似于文件的对象，而返回一个格式为(filename, headers)的元组，其中filename是本地文件的名称(由urllib 自动创建)，
而headers包含一些有关远程文件的信息(这里不会介绍headers，如果你想更深入地 了解它，请在有关urllib的标准库文档中查找urlretrieve)。
如果要给下载的副本指定文件名， 可通过第二个参数来提供。
```python
# 获取Python官网的主页，并将其存储到文件C:\python_webpage.html中
from urllib.request import urlretrieve
urlretrieve('http://www.python.org', 'C:\\python_webpage.html')
```
如果你没有指定文件名，下载的副本将放在某个临时位置，可使用函数open来打开。
但使用完毕后，你可能想将其删除，以免占用磁盘空间。要清空这样的临时文件，可调用函数urlcleanup且不提供任何参数，
它将负责替你完成清空工作。

> 一些实用的函数  
> + quote(string[, safe]):返回一个字符串，其中所有的特殊字符(在URL中有特殊意义的字符)都已替换为对URL友好的版本(如将~替换为%7E)。
> 如果要将包含特殊字符的 字符串用作URL，这很有用。参数safe是一个字符串(默认为'/')，包含不应像这样对其进行编码的字符。  
> + quote_plus(string[, safe]):类似于quote，但也将空格替换为加号。  
> + unquote(string):与quote相反。  
> + unquote_plus(string):与quote_plus相反。  
> + urlencode(query[, doseq]):将映射(如字典)或由包含两个元素的元组(形如(key, value))组成的序列转换为“使用URL编码的”字符串。
> 这样的字符串可用于CGI查询中(详 细信息请参阅Python文档)。
